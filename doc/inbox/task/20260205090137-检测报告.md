# zhengshuyun-common 全库代码检查报告

生成时间: 2026-02-05
仓库路径: /Users/toint/data/object/dev/zhengshuyun/zhengshuyun-common
Commit: b23a7b0f79445aac3e8f329a3135fa893b06056c
构建环境: Java 25.0.1, Maven 3.9.12

覆盖范围(按 git tracked 文件): 60 files, 49 Java files(12,659 LOC), 13 test files.

检查方式:
- 全量逐文件静态审阅(主代码, 测试代码, pom.xml, starter 资源文件).
- 执行 `mvn test`(通过).

结论(先说能确定的):
- 2 个确定性逻辑问题会直接产出错误结果(见: DurationFormatter, DataTransferUtil.calculatePercentage).
- 其余主要是 API 语义/空值契约不一致, 可维护性/兼容性风险, 以及测试稳定性问题.

## 严重: 结果错误

1) DurationFormatter: 子秒范围格式化会丢整秒.
- 位置: `zhengshuyun-common-core/src/main/java/com/zhengshuyun/common/core/time/DurationFormatter.java:219`, `zhengshuyun-common-core/src/main/java/com/zhengshuyun/common/core/time/DurationFormatter.java:255`.
- 现象: 当 range 不包含 `SECONDS`, 但包含 `MILLIS/MICROS/NANOS` 时, 只取 `duration.toNanosPart()`(0-999,999,999), 直接忽略 `duration.getSeconds()` 对应的整秒部分.
- 复现(已实测): `DurationFormatter.ofMillis(1500).setRange(ChronoUnit.MILLIS, ChronoUnit.NANOS).format()` 输出 `500ms`.
- 建议修复方向: 当 seconds 不在范围内且需要子秒单位时, 用 `seconds * 1_000_000_000 + nanosPart` 作为剩余纳秒源, 再拆分为 ms/us/ns(注意溢出边界).

2) DataTransferUtil.calculatePercentage: 大数会溢出, 百分比失真.
- 位置: `zhengshuyun-common-core/src/main/java/com/zhengshuyun/common/core/io/DataTransferUtil.java:72`.
- 现象: `current * 100 / total` 可能发生 long 溢出, 在极值下会返回明显错误的结果.
- 复现(已实测): `DataTransferUtil.calculatePercentage(Long.MAX_VALUE / 2, Long.MAX_VALUE)` 返回 `0`(直觉期望约 50).
- 建议修复方向: 避免乘法溢出, 用分解计算:
  - `q = current / total`, `r = current % total`, `pct = min(100, q * 100 + r * 100 / total)`.
  - 或在乘法可能溢出时 fallback 到 BigInteger/BigDecimal.

## 高: API 契约不一致, 容易踩坑

3) HttpResponse: 多个方法返回值可能为 null, 但签名未标注 @Nullable, 文档还写会返回 null.
- 位置: `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpResponse.java:152`, `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpResponse.java:166`, `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpResponse.java:191`.
- 影响: 调用方按非 null 使用会 NPE, 也会误导 IDE/nullness 工具.
- 建议: 给 `getHeader/getContentType/getLocation` 等加 `@Nullable`, 或提供 `getHeaderOrDefault` 的同类方法覆盖常用场景.

4) UrlProtocol: 标准协议匹配对 Locale 敏感, 且缺少 equals/hashCode.
- 位置: `zhengshuyun-common-core/src/main/java/com/zhengshuyun/common/core/net/UrlProtocol.java:99`.
- 现象:
  - `toLowerCase()` 使用默认 Locale, 在土耳其语等 Locale 下 `"FILE".toLowerCase()` 可能得到 `"fıle"`, 导致 `UrlProtocol.of("FILE")` 不返回常量 `FILE`.
  - 类未实现 `equals/hashCode`, `UrlProtocol.of("grpc")` 多次调用得到的对象无法按值比较, 容易引入隐藏 bug.
- 复现(已实测):
  - `UrlProtocol.of("grpc") == UrlProtocol.of("grpc")` 为 `false`, 且 `UrlProtocol.of("grpc").equals(UrlProtocol.of("grpc"))` 也为 `false`.
  - `Locale.setDefault(tr-TR)` 后, `UrlProtocol.of("FILE") == UrlProtocol.FILE` 为 `false`.
- 建议: `toLowerCase(Locale.ROOT)`, 统一存储 normalized name, 并基于 normalized 实现 `equals/hashCode`.

5) Retrier: callable 抛 InterruptedException 时可能吞掉中断语义.
- 位置: `zhengshuyun-common-core/src/main/java/com/zhengshuyun/common/core/retry/Retrier.java:157`.
- 现象: `catch (Throwable e)` 会把 `InterruptedException` 当普通失败处理, 且不恢复中断标志(抛出 InterruptedException 时标志会被清掉), 可能继续重试.
- 建议: 单独 catch `InterruptedException`, `Thread.currentThread().interrupt()` 后立即抛出(通常不应重试).

6) Retrier: 失败分支未清理 result, retryCondition 可能读到上一次成功值.
- 位置: `zhengshuyun-common-core/src/main/java/com/zhengshuyun/common/core/retry/Retrier.java:142`.
- 影响: 自定义条件如果在 `error != null` 仍读取 result, 可能做出错误决策.
- 建议: 失败时将 result 置为 null, 或把 result 变成每次循环内部变量.

## 中: 可维护性/兼容性/测试稳定性

7) HttpMethod: 依赖 OkHttp internal API, 版本升级风险高.
- 位置: `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpMethod.java:148`, `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpMethod.java:155`.
- 影响: `okhttp3.internal.*` 不承诺兼容性, OkHttp 升级可能直接编译失败或行为变化.
- 建议: 复制 permits/requires 的判定逻辑到本库, 或改为简单规则(至少避免 internal 依赖).

8) HttpRequest.MultipartBuilder: Validate 模板占位符风格误用.
- 位置: `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpRequest.java:399`, `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpRequest.java:401`.
- 现象: `Validate` 内部用的是 Guava `Strings.lenientFormat`(占位符是 `%s`), 但这里传入的是 `{}`. 失败时错误信息不会带上参数, 排障价值下降.
- 建议: 把 `{}` 改为 `%s`, 或在 Validate 层统一支持一种模板风格.

9) HttpUtil: javadoc 示例与实际 API 不一致.
- 位置: `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpUtil.java:219`.
- 现象: 示例里出现 `setAcceptJson()`/`getBody()` 等不存在的方法.
- 建议: 更新示例到可编译的调用(例如 `getBodyAsString()`), 或补齐对应 API.

10) HttpUtilTest: 单测依赖公网 postman-echo, 容易导致 CI 抖动.
- 位置: `zhengshuyun-common-http/src/test/java/com/zhengshuyun/common/http/HttpUtilTest.java:49`, `zhengshuyun-common-http/src/test/java/com/zhengshuyun/common/http/HttpUtilTest.java:614`.
- 影响: 外部服务不可控(网络, DNS, 限流, 证书), 单测会变成偶发失败.
- 建议: 用 OkHttp MockWebServer/WireMock, 或把这类用例标成 integration 并默认不跑.

11) spring-boot-starter: AutoConfiguration.imports 为空, starter 实际不生效.
- 位置: `zhengshuyun-common-spring-boot-starter/src/main/resources/META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports:1`.
- 建议: 如果是占位模块, 在 README 明确; 如果要发布可用 starter, 需要补齐 auto-configuration 类并注册.

12) HttpClient.Builder: public setter 缺少参数校验, 依赖 OkHttp 抛错.
- 位置: `zhengshuyun-common-http/src/main/java/com/zhengshuyun/common/http/HttpClient.java:279`.
- 影响: null/负 Duration 输入会在更深层失败, 错误点不友好.
- 建议: setter 入口处 `Validate.notNull`, 并拒绝负值.

## 已执行验证

- `mvn test`: PASS.

## 附录: 扫描统计

- tracked files: 60.
- Java files: 49(12,659 LOC), 其中 test: 13.
- Java files per module: core 30, http 12, json 7.

补充说明:
- 当前 git 工作区为 `main...origin/main [ahead 5]`, 且存在未追踪文件(例如 `CLAUDE.md`, `doc/inbox/task/20260205090137-检测报告-glm.md`). 本报告仅对 tracked 代码做全量覆盖, 未对 untracked 文件纳入结论.
