# Cron 表达式使用教程

本文面向初学者, 重点讲清楚在 `lava-schedule` 中如何正确使用 Cron 表达式.

## 先记住两个关键点

- `lava-schedule` 底层使用 Quartz Cron 语法, 常见是 6 段, 也支持可选第 7 段(年).
- `lava-schedule` 默认按 UTC 解析 Cron. 如果你的业务使用本地时区, 需要先换算再写表达式.

## 在 lava-schedule 里的基本用法

```java
import com.zhengshuyun.lava.schedule.ScheduleUtil;
import com.zhengshuyun.lava.schedule.ScheduledTask;
import com.zhengshuyun.lava.schedule.Trigger;

public class CronQuickStartDemo {

    public static void main(String[] args) {
        ScheduledTask task = ScheduleUtil.scheduler(() -> {
                    // TODO: 你的任务逻辑
                })
                // 任务 ID, 建议全局唯一
                .setId("daily-backup")
                // Cron: 每天 UTC 02:00 执行一次
                .setTrigger(Trigger.cron("0 0 2 * * ?").build())
                .schedule();

        // TODO: 按业务在合适时机 task.pause()/task.resume()/task.delete()
    }
}
```

## Cron 字段含义(Quartz 语法)

常见 6 段格式:

`秒 分 时 日 月 周`

可选第 7 段:

`秒 分 时 日 月 周 年`

字段范围:

| 字段    | 允许值            | 示例     |
|-------|----------------|--------|
| 秒     | 0-59           | `0`    |
| 分     | 0-59           | `30`   |
| 时     | 0-23           | `2`    |
| 日     | 1-31           | `15`   |
| 月     | 1-12 或 JAN-DEC | `*`    |
| 周     | 1-7 或 SUN-SAT  | `?`    |
| 年(可选) | 1970-2099      | `2026` |

## 常用符号速记

| 符号  | 含义          | 示例               | 解释                 |
|-----|-------------|------------------|--------------------|
| `*` | 任意值         | `* * * * * ?`    | 每秒执行               |
| `,` | 枚举多个值       | `0 0,30 * * * ?` | 每小时第 0 分和 30 分     |
| `-` | 区间          | `0 0 9-18 * * ?` | 每天 9 点到 18 点整点     |
| `/` | 步长          | `0 */5 * * * ?`  | 每 5 分钟             |
| `?` | 不指定(日和周二选一) | `0 0 2 * * ?`    | 日已指定时, 周用 `?`      |
| `L` | 最后          | `0 0 0 L * ?`    | 每月最后一天 00:00       |
| `W` | 工作日         | `0 0 9 15W * ?`  | 每月最接近 15 号的工作日 9 点 |
| `#` | 第几个星期几      | `0 0 9 ? * 2#1`  | 每月第 1 个周一 9 点      |

`?` 是初学者最容易踩坑的点:

- 当第 4 段(日)有明确规则时, 第 6 段(周)通常写 `?`.
- 当第 6 段(周)有明确规则时, 第 4 段(日)通常写 `?`.

## 可以直接复用的表达式

| 场景           | 表达式                   | 说明       |
|--------------|-----------------------|----------|
| 每 10 秒       | `0/10 * * * * ?`      | 秒字段步长 10 |
| 每 5 分钟       | `0 */5 * * * ?`       | 分字段步长 5  |
| 每天 UTC 02:00 | `0 0 2 * * ?`         | 日常离线任务常用 |
| 每周一 09:00    | `0 0 9 ? * MON`       | 周维度调度    |
| 每月 1 号 00:00 | `0 0 0 1 * ?`         | 月初结算     |
| 工作日 18:30    | `0 30 18 ? * MON-FRI` | 工作日下班任务  |

## 时区换算示例

如果业务要求"北京时间每天 02:00"触发, 而框架按 UTC 解析, 则表达式应写成前一天 UTC 18:00:

- 业务时间: UTC+8 02:00.
- 对应 UTC: 前一天 18:00.
- 表达式: `0 0 18 * * ?`.

建议在团队文档里明确一条规则: 所有 Cron 统一按 UTC 编写和评审.

## 常见错误与排查

### 表达式非法

```java
ScheduleUtil.scheduler(() -> {
        })
        .setId("bad-cron")
        .setTrigger(Trigger.cron("invalid-cron").build())
        .schedule();
```

上面会在调度阶段抛异常. 建议:

- 把关键 Cron 放进单元测试提前校验.
- 把表达式配置化时, 增加参数校验和启动期预检查.

### 时区理解错误

- 你以为是本地时间, 实际按 UTC 执行, 导致触发时间偏差.
- 解决办法: 统一时区策略, 并在配置文档中明确"表达式按 UTC 解释".